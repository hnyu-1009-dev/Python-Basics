# =====================================================================================================
# ğŸ“˜ Python è¿­ä»£å™¨
# -----------------------------------------------------------------------------------------------------
# ğŸ§  è¯­æ³•ç³–çš„æœ¬è´¨
# âœ… ä½œç”¨ï¼šè®©ç¨‹åºæ›´å®¹æ˜“è¢«äººç†è§£å’Œç¼–å†™ã€‚
# âŒ ä¸æ”¹å˜åº•å±‚é€»è¾‘ï¼šç¼–è¯‘å™¨æˆ–è§£é‡Šå™¨æœ€ç»ˆä¼šæŠŠè¯­æ³•ç³–è½¬æ¢ï¼ˆDesugarï¼‰æˆåŸæœ¬çš„åº•å±‚å®ç°ã€‚
# è¯­æ³•ç³–å†™æ³•
squares = [x ** 2 for x in range(5)]
# ç­‰ä»·çš„â€œå»ç³–â€å†™æ³•
squares = []
for x in range(5):
    squares.append(x ** 2)
# -----------------------------------------------------------------------------------------------------
# ğŸ§  ä¸€ã€è¿­ä»£å™¨ï¼ˆIteratorï¼‰
# è¿­ä»£å™¨æ˜¯ä¸€ä¸ªå¯ä»¥è®°ä½éå†çš„ä½ç½®çš„å¯¹è±¡ã€‚
# è¿­ä»£å™¨å¯¹è±¡ä»é›†åˆçš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹è®¿é—®ï¼Œç›´åˆ°æ‰€æœ‰çš„å…ƒç´ è¢«è®¿é—®å®Œç»“æŸã€‚è¿­ä»£å™¨åªèƒ½å¾€å‰ä¸ä¼šåé€€ã€‚
# è¿­ä»£å™¨æœ‰ä¸¤ä¸ªåŸºæœ¬çš„æ–¹æ³•ï¼š
# __init__(self) -> Iteratorå¯¹è±¡åˆå§‹åŒ–
# __next__(self) -> è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªå…ƒç´ åˆ™æŠ›å‡ºStopIterationå¼‚å¸¸
# Python çš„ forã€inã€next()ã€enumerate()ã€è§£åŒ…ï¼ˆunpackingï¼‰ç­‰è¯­æ³•ç³–ï¼Œæœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

# ğŸ•¹ï¸è¿­ä»£å™¨çš„æµç¨‹
# 1.è°ƒç”¨iter(obj) -> è·å–è¿­ä»£å™¨å¯¹è±¡ï¼›
# 2.å¾ªç¯ä¸­è‡ªåŠ¨è°ƒç”¨ next(iterator);
# 3.è¿­ä»£å®Œæˆä¼šè‡ªåŠ¨æ•è·å¹¶æŠ›å‡ºæ•è· StopIteration å¼‚å¸¸ã€‚

# â—å¯è¿­ä»£å¯¹è±¡ VS  è¿­ä»£å™¨å¯¹è±¡
# å¯è¿­ä»£å¯¹è±¡ï¼šå®ç°äº† __iter__() æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ã€‚
# è¿­ä»£å™¨å¯¹è±¡ï¼šå®ç°äº† __iter__() å’Œ __next__() æ–¹æ³•ï¼Œå¯ä»¥è¢« next() è°ƒç”¨å¹¶ä¸æ–­è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ ã€‚
# å­—ç¬¦ä¸²ã€åˆ—è¡¨ã€å…ƒç»„ã€å­—å…¸ã€æ–‡ä»¶ç­‰éƒ½æ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œä½†ä¸æ˜¯è¿­ä»£å™¨å¯¹è±¡ã€‚
# â— è¿­ä»£å™¨ä¸€å®šæ˜¯å¯è¿­ä»£å¯¹è±¡ï¼Œå¯è¿­ä»£å¯¹è±¡ä¸ä¸€å®šæ˜¯è¿­ä»£å™¨
# ç”¨ä»£ç æ¥å®ç°åˆ¤æ–­
# from collections.abc å¯¼å…¥â€œæŠ½è±¡åŸºç±»â€ï¼ˆAbstract Base Classes, ABCï¼‰
# Iterable ä¸ Iterator éƒ½æ˜¯â€œåè®®ï¼ˆprotocolï¼‰â€çš„æŠ½è±¡å®šä¹‰ï¼Œ
# ç”¨äºåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦â€œå¯è¿­ä»£â€æˆ–æ˜¯å¦æ˜¯â€œè¿­ä»£å™¨â€ã€‚
from collections.abc import Iterable, Iterator

# isinstance(obj, Iterable) ç”¨æ¥åˆ¤æ–­ obj æ˜¯å¦æ»¡è¶³â€œå¯è¿­ä»£åè®®â€
# å¯è¿­ä»£ï¼ˆIterableï¼‰çš„æœ€æ ¸å¿ƒç‰¹å¾ï¼šå®ç°äº† __iter__ æ–¹æ³•ï¼Œ
# è°ƒç”¨ iter(obj) èƒ½è¿”å›ä¸€ä¸ªâ€œè¿­ä»£å™¨â€å¯¹è±¡ï¼ˆIteratorï¼‰ã€‚
# åˆ—è¡¨ï¼ˆlistï¼‰æ˜¯å…¸å‹çš„å¯è¿­ä»£å¯¹è±¡ï¼Œå› æ­¤ç»“æœä¸º Trueã€‚
print(isinstance([], Iterable))  # True

# isinstance(obj, Iterator) ç”¨æ¥åˆ¤æ–­ obj æ˜¯å¦æœ¬èº«å°±æ˜¯â€œè¿­ä»£å™¨â€
# è¿­ä»£å™¨ï¼ˆIteratorï¼‰çš„æ ¸å¿ƒç‰¹å¾ï¼šæ—¢æ˜¯ Iterableï¼ˆæœ‰ __iter__ï¼‰ï¼Œ
# è¿˜å®ç°äº† __next__ï¼ˆåœ¨ Python ä¸­ç”±å†…ç½®å‡½æ•° next() é©±åŠ¨ï¼‰ã€‚
# æ³¨æ„ï¼šåˆ—è¡¨ä¸æ˜¯è¿­ä»£å™¨ï¼ˆå®ƒæ²¡æœ‰ __next__ï¼‰ï¼Œéœ€è¦é€šè¿‡ iter() äº§ç”Ÿè¿­ä»£å™¨ã€‚
print(isinstance([], Iterator))  # False

# iter(obj) ä¼šå¯¹â€œå¯è¿­ä»£å¯¹è±¡â€åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªå¯¹åº”çš„è¿­ä»£å™¨ï¼Œ
# ä¾‹å¦‚ iter([]) è¿”å› list_iterator å¯¹è±¡ã€‚è¿­ä»£å™¨èƒ½è¢« next() é€ä¸ªå–å€¼ï¼Œ
# å¹¶åœ¨å–å°½åæŠ›å‡º StopIteration å¼‚å¸¸ã€‚
print(isinstance(iter([]), Iterator))  # True
# -----------------------------------------------------------------------------------------------------
# ğŸ§©ä»£ç ç»ƒä¹ 1
data = [1, 2, 3, 4, 5]
iter_data = iter(data)  # åˆ›å»ºä¸€ä¸ªå¯è¿­ä»£å¯¹è±¡
print(next(iter_data))  # 1
print(next(iter_data))  # 2
print(next(iter_data))  # 3
print(next(iter_data))  # 4
print(next(iter_data))  # 5
try:
    print(next(iter_data))  # StopIteration
except StopIteration:
    print("Iteration is done.")  # è¿­ä»£å®Œæˆ


# -----------------------------------------------------------------------------------------------------
# ğŸ§©ä»£ç ç»ƒä¹ 2
# å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„è¿­ä»£å™¨
# â— è‡ªå®šä¹‰è¿­ä»£å™¨çš„æ ¸å¿ƒæ˜¯ï¼Œåœ¨__init__()æ–¹æ³•ä¸­ä¸æ–­åˆå§‹åŒ–å†…ç½®çŠ¶æ€
class ReusableCounter:
    def __init__(self, low, high):
        self.low = low
        self.high = high
        self.current = low

    def __iter__(self):  # åœ¨å¤šæ¬¡è°ƒç”¨æ—¶ï¼Œé‡åˆ¶å±æ€§çŠ¶æ€ã€‚
        self.current = self.low
        return self

    def __next__(self):  # è¿”å›ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶æ›´æ–°çŠ¶æ€ã€‚  #ä¸”æ— æ³•å›å¤´ï¼Œä¹‹å‰çš„æ•°æ®éƒ½è¢«è¿­ä»£åæ›´æ–°äº†ã€‚
        if self.current > self.high:
            raise StopIteration
        else:
            self.current += 1
            return self.current - 1


for x in ReusableCounter(1, 5):
    print(x, end=' ')  # 1 2 3 4 5


# ğŸ•¹ï¸for æ¯æ¬¡éƒ½ä¼šé€šè¿‡ iter() è°ƒç”¨ __iter__()äºæ˜¯æ¯æ¬¡è¿­ä»£éƒ½ä¼šè‡ªåŠ¨é‡ç½® current åˆ°èµ·ç‚¹ï¼Œä»è€Œèƒ½â€œé‡å¤ä½¿ç”¨â€ã€‚
#   ä½†æ˜¯å¯¹äºè¿™ä¸ªforå¾ªç¯ä¸­ï¼ŒReusableCounter(1, 5)æœ¬èº«å°±ä¼šè¿”å›ä¸€ä¸ªè¿­ä»£å™¨å¯¹è±¡ï¼Œforå¾ªç¯é¦–å…ˆå¯¹è¿™ä¸ª
#   è¿­ä»£å™¨å¯¹è±¡ä½¿ç”¨iter(),è¿”å›çš„è¿˜æ˜¯è¿™ä¸ªè¿­ä»£å™¨å¯¹è±¡æœ¬èº«ã€‚
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚                for å¾ªç¯å¼€å§‹
# â”‚           for x in <å¯è¿­ä»£å¯¹è±¡>:
# â”‚                 <å¾ªç¯ä½“>
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ è°ƒç”¨ iter(<å¯è¿­ä»£å¯¹è±¡>)
#         â”‚ â†’ è§¦å‘å¯¹è±¡çš„ __iter__()
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ è¿”å›ä¸€ä¸ª è¿­ä»£å™¨ (Iterator)
#         â”‚ æ³¨æ„ï¼šå¦‚æœå¯¹è±¡æœ¬èº«æ˜¯è¿­ä»£å™¨
#         â”‚ iter(obj) ç›´æ¥è¿”å›è‡ªå·±
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ å¼€å§‹å¾ªç¯è°ƒç”¨ next()
#         â”‚ â†’ è°ƒç”¨ è¿­ä»£å™¨.__next__()
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ __next__() è¿”å›ä¸€ä¸ªå€¼
#         â”‚  â†’ èµ‹ç»™å˜é‡ x
#         â”‚  â†’ æ‰§è¡Œå¾ªç¯ä½“
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ å†æ¬¡è°ƒç”¨ next()
#         â”‚ é‡å¤ä¸Šä¸€æ­¥
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ å½“æ²¡æœ‰æ›´å¤šæ•°æ®æ—¶
#         â”‚ __next__() æŠ›å‡º StopIteration
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#                     â”‚
#                     â–¼
#         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
#         â”‚ for æ•è· StopIteration
#         â”‚ â†’ è‡ªåŠ¨ç»“æŸå¾ªç¯
#         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
# -----------------------------------------------------------------------------------------------------
# ğŸ§©ä»£ç ç»ƒä¹ 3:åŒçŠ¶æ€è¿­ä»£å™¨ï¼ˆæ¨¡æ‹Ÿæ•°æ®ç¼“å†²åŒºï¼‰
# â—é‡ç‚¹ç†è§£ä¸ºä»€ä¹ˆpeekä¸ä¼šæ¶ˆè´¹
# â—æ¶ˆè´¹çš„çœŸæ­£å«ä¹‰æ˜¯ï¼ŒæŒ‡é’ˆå‘åç§»åŠ¨ï¼Œè¿™ä¸ªä»£ç ä¸­çš„peekè™½ç„¶ä¹Ÿè®©æŒ‡é’ˆåç§»ï¼Œä½†æ˜¯ä»–å°†å€¼æš‚å­˜åˆ°äº†bufferç¼“å†²åŒºä¸­
#   ä¸‹æ¬¡nextç›´æ¥ä»ç¼“å†²åŒºä¸­å–èµ°æ•°æ®å°±è¡Œã€‚
class BufferedIterator:
    def __init__(self, source):
        self.source = iter(source)
        print("è¿™é‡Œæ˜¯initä¸­çš„source", self.source)
        self._buffer = None

    def __iter__(self):
        return self

    def __next__(self):
        if self._buffer is not None:
            result, self._buffer = self._buffer, None
            return result
        return next(self.source)

    def peek(self):
        if self._buffer is None:
            self._buffer = next(self.source)  # æ³¨æ„è¿™é‡Œçš„ next
            print("è¿™é‡Œæ˜¯peekä¸­çš„_source", self.source)
        return self._buffer


# ä½¿ç”¨
it = BufferedIterator(range(5))
print("è¿™é‡Œæ˜¯å®ä¾‹åŒ–åçš„BufferedIteratorçš„å¯¹è±¡it", it)

print(it.peek())  # 0ï¼ˆæŸ¥çœ‹ä¸‹ä¸€ä¸ªå€¼ä½†ä¸æ¶ˆè´¹ï¼‰
print("è¿™é‡Œæ˜¯peekåçš„_source", it.source)
print(next(it))  # 0
print("è¿™é‡Œæ˜¯nextåçš„_source", it.source)
print(next(it))  # 1
print(it.peek())
print(it.peek())


# ==================================
# ===================================================================
# ğŸ“˜ Python ç”Ÿæˆå™¨
# ğŸ§  ç”Ÿæˆå™¨æ˜¯å®ç°è¿­ä»£å™¨åè®®çš„å‡½æ•°å¯¹è±¡ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„è¿­ä»£å™¨ï¼Œå®ƒä¸å­˜å‚¨æ‰€æœ‰æ•°æ®ï¼Œè€Œæ˜¯ç”Ÿæˆæ•°æ®ã€‚
#    è°ƒç”¨ç”Ÿæˆå™¨çš„å‡½æ•°ä¸ä¼šæ‰§è¡Œå‡½æ•°ä½“ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå¯è¿­ä»£çš„generatorå¯¹è±¡
def gen():
    yield 1
    yield 2


g = gen()
print(next(g))  # 1
print(next(g))  # 2


# yield ä¼šæš‚åœå‡½æ•°æ‰§è¡Œï¼Œä¿å­˜å±€éƒ¨å˜é‡ä¸æ‰§è¡Œæ ˆã€‚
# ä¸‹æ¬¡ next() è°ƒç”¨ä»ä¸Šæ¬¡ä¸­æ–­ç‚¹æ¢å¤æ‰§è¡Œã€‚
# å½“æ‰§è¡Œå®Œæ‰€æœ‰ä»£ç åï¼Œä¼šè‡ªåŠ¨æŠ›å‡º StopIteration å¼‚å¸¸ï¼ˆfor å¾ªç¯è‡ªåŠ¨æ•è·å®ƒï¼‰ã€‚
def simple_gen():
    yield 1
    yield 2
    yield 3


g = simple_gen()
print(next(g))  # 1
print(next(g))  # 2
print(next(g))  # 3
try:
    print(next(g))  # StopIteration
except StopIteration:
    print("ç”Ÿæˆå™¨ç»“æŸ")
